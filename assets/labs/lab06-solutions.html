<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>CITS3007 lab 6 (week 8) – Injection – solutions</title>
  <style>
    html {
      line-height: 1.5;
      font-family: sans serif;
      font-size: 12pt;
      color: black;
      background-color: white;
    }
    body {
      margin: 0 auto;
      max-width: 50em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      background-color: hsl(0, 0%, 98%);
      padding: .2em .4em;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      background-color: hsl(0, 0%, 98%);
      padding: 1em;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    /* Inline code */
    :not(pre) > code {
      padding: 2px 4px;
      font-size: 90%;
      word-break: normal !important;
      white-space: nowrap;
      color: hsl(344.8,69%,10%);
      background-color: hsl(342.9,37%,96%);
      border-radius: 4px;
    }
    .sourceCode {
     background-color: hsl(0, 0%, 98%);
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid black;
      border-bottom: 1px solid black;
    }
    th {
      border-top: 1px solid black;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <style>
    div.solutions {
      border: solid 2pt hsla(120, 100%, 35%, 1);
      border-radius: 5pt;
      background-color: hsla(120, 100%, 50%, 0.1);
      padding: 1em;
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">CITS3007 lab 6 (week 8) – Injection – solutions</h1>
</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Contents</h2>
<ul>
<li><a href="#environment-variables">1. Environment variables</a>
<ul>
<li><a href="#environment-variables-and-fork">1.3. Environment variables
and <code>fork</code></a></li>
<li><a href="#environment-variables-and-execve">1.2. Environment
variables and <code>execve</code></a></li>
<li><a href="#environment-variables-and-system">1.4. Environment
variables and <code>system</code></a></li>
<li><a href="#setuid-programs-and-system">1.5. <code>setuid</code>
programs and <code>system</code></a></li>
</ul></li>
<li><a href="#building-libraries">2. Building libraries</a>
<ul>
<li><a href="#static-libraries">2.1. Static libraries</a></li>
<li><a href="#dynamic-shared-libraries">2.2. Dynamic shared
libraries</a></li>
<li><a href="#ld_library_path-and-setuid">2.2.
<code>LD_LIBRARY_PATH</code> and setuid</a></li>
</ul></li>
</ul>
</nav>
<p></p>
<h2 id="environment-variables">1. Environment variables</h2>
<p>Every process has access to a set of <em>environment variables</em>.
In C, they are represented as the variable <code>char **environ</code>
(see <code>man 7 environ</code> for additional details): this variable
allows us to read, write, and and delete environment variables. We can
also manipulate them from the shell.</p>
<p>Note that Bash lets us set variables using the syntax</p>
<pre><code>$ myvar=myval</code></pre>
<p>but these variables are “Bash” variables, not environment variables,
and are only accessible within our current shell session. (This is
similar to the way <code>gdb</code> lets us set convenience variables:
they are accessible only from our <code>gdb</code> session, and are not
part of and do not affect the program being debugged.)</p>
<p>Try the following:</p>
<pre><code>$ myvar=myval
$ echo my var is $myvar
$ sh -c &#39;echo my var is $myvar&#39;</code></pre>
<p>Only the first <code>echo</code> command prints the expected contents
of <code>myvar</code>. The second time around, we are spawning a new
shell process, and within that process, the variable <code>myvar</code>
has not been defined.</p>
<p><em>Environment</em> variables, however, <em>are</em> inherited by
child processes. We can use <code>export</code> to turn a normal
variable into an environment variable:</p>
<pre><code>$ myvar=myval
$ echo my var is $myvar
$ export myvar
$ sh -c &#39;echo my var is $myvar&#39;</code></pre>
<p>This time, we should see the expected contents of <code>myvar</code>
echoed twice. We can also define and export a variable in a single
step:</p>
<pre><code>$ export myvar=myval</code></pre>
<p>Besides the builtin Bash “<code>echo</code>” command, the
“<code>declare</code>” command can be useful for displaying variable
contents as well. “<code>declare -p myvar</code>” means to display the
definition of <code>myvar</code> (note that we do <em>not</em> put a
dollar sign in front of <code>myvar</code> this time –
“<code>declare -p</code>” needs the <em>name</em> of a variable, not its
value).</p>
<pre><code>$ declare -p myvar
declare -x myvar=&quot;myval&quot;</code></pre>
<h3 id="environment-variables-and-fork">1.3. Environment variables and
<code>fork</code></h3>
<p>Save the following program as <code>child_env.c</code>, and compile
it with <code>make child_env.o child_env</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">char</span> <span class="op">**</span>environ<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> printenv<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span>environ<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> environ<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        i<span class="op">++;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    pid_t childPid<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span><span class="op">(</span>childPid <span class="op">=</span> fork<span class="op">())</span> <span class="op">{</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span>    <span class="co">// child process</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">//printenv();</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span>   <span class="co">// parent process</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            printenv<span class="op">();</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Once <code>fork</code> has been called, the code detects whether it
is running in the child process (the result of <code>fork()</code> was
0) or the parent (the result of <code>fork()</code> id the process ID of
the child process – see <code>man 2 fork</code>). Currently, the
<em>parent</em>’s environment is printed, using the
<code>printenv</code> function. If you run <code>./child_env</code>,
you’ll see a large amount of output – so we’ll redirect it to a
file:</p>
<pre><code>$ ./child_env &gt; parent_env.txt</code></pre>
<p>Now comment out the parent call to <code>printenv()</code>, and
uncomment the child’s, re-compile, and then run again:</p>
<pre><code>$ ./child_env &gt; child_env.txt</code></pre>
<p>If we compare our two files using diff (or in a graphical
environment, you could use a command like <code>meld</code>), we see
they are the same:</p>
<pre><code>$ diff parent_env.txt child_env.txt</code></pre>
<p>So it appears the child gets an exact copy of the parent’s
environment.</p>
<h3 id="environment-variables-and-execve">1.2. Environment variables and
<code>execve</code></h3>
<p>Save the following program as <code>use_execve.c</code>, and compile
with <code>make use_execve.o use_execve</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">char</span> <span class="op">**</span>environ<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>myargv<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    myargv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;/usr/bin/printenv&quot;</span><span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    myargv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    execve<span class="op">(</span><span class="st">&quot;/usr/bin/printenv&quot;</span><span class="op">,</span> myargv<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Read <code>man 2 execve</code> for details of the <code>execve</code>
function (which we also looked at in lectures). The first argument is a
program to run: when <code>execve</code> is called, this program
“replaces” the one currently running. The second argument is a list of
the arguments passed to the new program. It has the same purpose and
structure as <code>argv</code> does in <code>main</code> of a C program,
and is an array of strings, terminated by a <code>NULL</code> pointer;
the <em>first</em> of these normally holds the name of the program being
executed (though this is only a convention, and programs sometimes set
<code>argv[0]</code> to other things). The last argument is to an array
of strings representing the environment of the new program. We have set
it to <code>NULL</code> – what do you predict the output of running the
program will be?</p>
<p>Now, replace the call to execve with the following, then recompile
and rerun:</p>
<pre><code>execve(&quot;/usr/bin/env&quot;, argv, environ);</code></pre>
<p>From reading the man page for execve, what do you predict will be the
output?</p>
<h3 id="environment-variables-and-system">1.4. Environment variables and
<code>system</code></h3>
<p>Save the following program as <code>use_system.c</code>, and compile
with <code>make use_system.o use_system</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/usr/bin/printenv&quot;</span><span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;back in use_system&quot;</span><span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You can read about the <code>system</code> function using
<code>man 3 system</code>. What do you predict will be the output?
Should you see the output of <code>printf</code>?</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>Yes – <code>system</code> spawns a new process using
<code>fork</code> and returns, so the <code>printf</code> <em>will</em>
be executed.</p>
</div>
<h3 id="setuid-programs-and-system">1.5. <code>setuid</code> programs
and <code>system</code></h3>
<p>Save the following program as <code>run_cat.c</code>, and compile
with <code>make run_cat.o run_cat</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">size_t</span> BUF_SIZE <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> buf<span class="op">[</span>BUF_SIZE<span class="op">];</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;\0&#39;</span><span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;supply a file to read</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  strcat<span class="op">(</span>buf<span class="op">,</span> <span class="st">&quot;cat &quot;</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  strcat<span class="op">(</span>buf<span class="op">,</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  system<span class="op">(</span>buf<span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If we invoke this as <code>./run_cat SOMEFILE</code>, we should be
able to get the contents of the file using the <code>cat</code> command
(see <code>man 1 cat</code>). Try running
<code>./run_cat /etc/shadow</code> – you should get a “permission
denied” error, which we expect, because <code>root</code> owns
<code>/etc/shadow</code>, and normal users do not have read access.</p>
<p>Now make <code>run_cat</code> a setuid program:</p>
<pre><code>$ sudo chown root:root ./run_cat
$ sudo chmod u+s ./run_cat</code></pre>
<p>Try running <code>./run_cat /etc/shadow</code> again – what do you
see, and why? Instead of <code>cat</code>, you can imagine that we might
instead invoke some other command which normally only root can run, but
which we want to let other users run.</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>As a setuid program, <code>run_cat</code> now runs with effective
user ID of 0 (that is, <code>root</code>), and <em>will</em> be able to
read <code>/etc/shadow</code>.</p>
</div>
<p>You can find out where the <code>cat</code> command is that
<code>run_cat</code> is executing by running</p>
<pre><code>$ which cat</code></pre>
<p>This will look through the directories in our <code>PATH</code>, and
report the first one which contains an executable file called
“<code>cat</code>”. Now we will manipulate the <code>PATH</code>
environment variable so that <code>run_cat</code> instead of accessing
the normal system <code>cat</code> command, executes a command of our
choosing.</p>
<p>Create a file <code>cat.c</code> in the current directory, and edit
with <code>vim</code>, adding the following contents, then compile with
<code>make cat.o cat</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  uid_t euid <span class="op">=</span> geteuid<span class="op">();</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;DOING SOMETHING MALICIOUS, with effective user ID %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> euid<span class="op">);</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Type</p>
<pre><code>$ export PATH=$PWD:$PATH</code></pre>
<p>and run <code>run_cat</code> again.</p>
<pre><code>$ ./run_cat /etc/shadow</code></pre>
<p>What do you see? Why? And how would you fix this?</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>Because we have put our current working directory (<code>$PWD</code>)
at the start of <code>PATH</code>, <code>system</code> will look there
first for a command called <code>cat</code>.</p>
<p>It will find our malicious <code>cat</code> program, and run it with
effective user ID of <code>root</code>. This means if a setuid program
uses a call like <code>system(some_string)</code> – which has the effect
of running <code>sh -c some_string</code> – a user can replace commands
in <code>some_string</code> with malicious versions of their own,
<em>and</em> execute this with root privileges.</p>
<p>To fix this, there are several options:</p>
<ul>
<li><p>Use absolute paths in <code>some_string</code>, rather than
letting the shell look for commands in the <code>PATH</code>. For more
flexibility, we might look in several set locations (e.g. both
<code>/bin</code> and <code>/usr/bin</code>), as not all operating
systems put commands in the exact same location.</p>
<p>(Ideally, it would be best to ensure those directories are writable
only by <code>root</code>; if one of them can be written to by non-root
users, then we haven’t actually fixed the problem, since a non-root user
could still insert a malicious binary in those locations.)</p></li>
<li><p>Not use <code>system</code> at all; instead, use
<code>fork</code> and <code>execve</code> ourselves, building up a set
of arguments which can be passed to <code>execve</code>.</p></li>
</ul>
</div>
<h2 id="building-libraries">2. Building libraries</h2>
<p>Save the following code as <code>mylib.c</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> useful_func<span class="op">(</span><span class="dt">int</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;Some very useful functionality</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We can build an object file <code>mylib.o</code> as follows:<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<pre><code>$ gcc -g -fPIC -c mylib.c</code></pre>
<p>Now that our <code>useful_func</code> function has been compiled into
object code, it can be used in other programs. There are a few options
for doing so.</p>
<p>We could link the <code>mylib.o</code> object file directly into a
new program – this is what we do when we build large, multi-file C
programs. When given a set of object files, <code>gcc</code> will know
it’s being asked to invoke the <em>linker</em>, and will combine
multiple object files together (together with the builtin C standard
library). When doing so, we invoke <code>gcc</code> like this:</p>
<pre><code>$ gcc -o myprog obj1.o obj2.o ...</code></pre>
<p>We could also build a <em>library</em> containing our new function,
and make this available to other developers. There are two options for
doing so: we can build a static library, or a shared (dynamic)
library.</p>
<h3 id="static-libraries">2.1. Static libraries</h3>
<p>On Linux, a static library is a set of object files combined into a
single “<code>ar</code>”-format “archive” file. You can think of it as
being like a <code>.zip</code> or <code>.tar</code> file containing one
or more “<code>.o</code>” files. The <code>ar</code> command builds
archive files in this format. (You can look up <code>man ar</code> for
more details, but they are not essential for our purposes.)</p>
<p>The following command will build a static library containing our
object file, located in the directory <code>static-libs</code>:</p>
<pre><code>$ mkdir -p static-libs
$ ar rcs ./static-libs/libmylib.a mylib.o</code></pre>
<p>This produces the static library file <code>libmylib.a</code>. To use
the static library in a program, we need to tell the linker to link
against our library, and also where our library is located.
<code>gcc</code> normally looks for libraries in default locations – in
the standard CITS3007 development environment, one of these locations is
the directory <code>/usr/lib/x86_64-linux-gnu/</code>. If you list the
contents of that directory, you find a number of static libraries – one
for instance is <code>/usr/lib/x86_64-linux-gnu/libcrypt.a</code>, part
of the <a href="https://salsa.debian.org/md/libxcrypt">libxcrypt</a>
library.</p>
<p>To make our <code>useful_func</code> function easy to use by other
developers, we would normally also provide them with appropriate header
files, but in this case we will manually insert the declarations for
<code>useful_func</code>.</p>
<p>Insert the following into a file <code>usemylib.c</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> useful_func<span class="op">(</span><span class="dt">int</span> s<span class="op">);</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">calling useful_func routine:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  useful_func<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We can compile it with <code>gcc -c -g usemylib.c</code>, and then
link it against our static library. The <code>-L</code> option to
<code>gcc</code> indicates a non standard directory where libraries can
be found, and the <code>-l</code> option gives the name of a library to
link. (<code>gcc</code> by default assumes it should add
<code>lib</code> in front of this name and <code>.a</code> after, to get
the filename to link against.)</p>
<pre><code>$ gcc  usemylib.o  -L./static-libs -lmylib -o statically-linked-usemylib</code></pre>
<p>Run the binary with <code>./statically-linked-usemylib</code>. This
executable contains a <em>full copy</em> of the
<code>useful_func()</code> binary code from our <code>mylib.o</code>
file.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div style="border: solid 2pt blue; background-color: hsla(241, 100%,50%, 0.1); padding: 1em; border-radius: 5pt; margin-top: 1em;">
<p><strong>Static vs shared libraries</strong></p>
<p>Users and developers tend to favour using <em>statically</em> linked
libraries in executables. It makes the executable larger than if it used
shared libraries (discussed in the next section), because a full copy of
the library routines is copied into the executable; but on the other
hand, it makes the executable more portable and self-contained, and
there’s no need to to download the executable, <em>and</em> installed
the shared libraries needed to run it.</p>
<p>System administrators, on the other hand, often tend to prefer it
when executables use shared libraries. One reason is that multiple
executables can all use the same shared library, taking up less disk
space. But a more significant reason is that it’s easier to fix things
if a vulnerability is found in the library.</p>
<p>If a new version of a shared library is installed which fixes a
vulnerability, then all executables using that shared library get the
benefit of using the new version (without needing to update the
executables). On the other hand, if there are executables which are
linked <em>statically</em> against the library, we must ensure each one
has been updated “upstream” (i.e. by the developer of the executable) to
incorporate the fixed library version, and download and install each
executable.</p>
</div>
<h3 id="dynamic-shared-libraries">2.2. Dynamic shared libraries</h3>
<p>We can create a <em>shared</em> library with the following
commands:</p>
<pre><code>$ mkdir -p shared-libs
$ gcc -shared mylib.o -o shared-libs/libmylib.so</code></pre>
<p>To link against this shared library, we invoke gcc as follows:</p>
<pre><code>$ gcc usemylib.o -L./shared-libs -lmylib -o dynamically-linked-usemylib</code></pre>
<p>Try running <code>./dynamically-linked-usemylib</code>. You should
see an error message like the following:</p>
<pre><code>error while loading shared libraries: libmylib.so: cannot open shared object file: No such file or directory</code></pre>
<p>When an executable that makes use of shared libraries is run, a
program called the <a href="https://en.wikipedia.org/wiki/Dynamic_linker">dynamic linker</a>
is responsible for finding the necessary libraries<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> and
looking up the location of any requested functions in those libraries.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> In the present case, it doesn’t know
where to find the file <code>libmylib.so</code>, so it reports an
error.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>We could fix this by putting the <code>.so</code> file in a standard
location (<code>/usr/lib/x86_64-linux-gnu/</code>) where the dynamic
linker can find it, or we can use the <code>LD_LIBRARY_PATH</code>
environment variable to specify the location.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> The
<code>LD_LIBRARY_PATH</code> environment variable contains a list of
locations where the dynamic linker should look for shared libraries. Run
the following:</p>
<pre><code>$ LD_LIBRARY_PATH=./shared-libs ./dynamically-linked-usemylib</code></pre>
<p>You should see that the executable runs without error, and calls the
<code>useful_func</code> function in our shared library.</p>
<p>Now let’s imagine some adversary has created a version of the
<code>mylib</code> library which contains malicious code.</p>
<p>Create the following file, <code>evil_lib.c</code>, and compile it
with <code>gcc -g -fPIC -c evil_lib.c</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> useful_func<span class="op">(</span><span class="dt">int</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// we could now run arbitrary code and cause damage.</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Malicious things -- bwahaha!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Build a library from it using the following commands:</p>
<pre><code>$ mkdir -p evil-shared-libs
$ gcc -shared evil_lib.o -o evil-shared-libs/libmylib.so</code></pre>
<p>And run our existing dynamically linked binary, but with a different
<code>LD_LIBRARY_PATH</code>:</p>
<pre><code>$ LD_LIBRARY_PATH=./evil-shared-libs ./dynamically-linked-usemylib</code></pre>
<p>What happens, and what are the security implications of this?</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>The function in the malicious version of the library is called. If a
user can control the value of <code>LD_LIBRARY_PATH</code>, they can
arrange for a malicious version of existing libraries to be run.</p>
</div>
<p>In principle, we could use this technique even to override functions
in <code>libc</code>, the standard C library. But note that in the
normal case, code will only be run with a user’s normal privileges. This
is still a security issue (malicious libraries could, for instance,
email copies of the user’s private files), but doesn’t give superuser
access to a machine. However, what happens if the binary is a setuid
executable?</p>
<h3 id="ld_library_path-and-setuid">2.2. <code>LD_LIBRARY_PATH</code>
and setuid</h3>
<p>Try making <code>dynamically-linked-usemylib</code> a root-owned
setuid program, and then running it with a specified
<code>LD_LIBRARY_PATH</code>:</p>
<pre><code>$ sudo chown root:root ./dynamically-linked-usemylib
$ sudo chmod u+s ./dynamically-linked-usemylib
$ LD_LIBRARY_PATH=./shared-libs ./dynamically-linked-usemylib</code></pre>
<p>What do you observe?</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>An error should occur, stating that libmylib.so can’t be found.</p>
</div>
<p>Let’s find out why this occurs. Create the following program,
<code>print_ld_env.c</code>, and compile it with
<code>make print_ld_env.o print_ld_env</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">char</span> <span class="op">**</span>environ<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;some environment variables:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">char</span> <span class="op">**</span>var <span class="op">=</span> environ<span class="op">;</span> <span class="op">*</span>var <span class="op">!=</span> NULL<span class="op">;</span> var<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strncmp<span class="op">(*</span>var<span class="op">,</span> <span class="st">&quot;LD&quot;</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">&quot;var %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">*</span>var<span class="op">);</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Run it with several environment variables set:</p>
<pre><code>$ LD_LIBRARY_PATH=./shared-libs LD_SOME_RANDOM_VAR=xxx ./print_ld_env</code></pre>
<p>What do you see? What is the program doing?</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>The program is printing out the name and contents of any environment
variables that begin with the letters “LD”.</p>
</div>
<p>Make the <code>print_ld_env</code> a setuid executable, and run it
again:</p>
<pre><code>$ sudo chown root:root ./print_ld_env
$ sudo chmod u+s ./print_ld_env
$ LD_LIBRARY_PATH=./shared-libs LD_SOME_RANDOM_VAR=xxx ./print_ld_env</code></pre>
<p>What do you observe? Why might this happen? (Hint: check the
<code>man 8 ld.so</code> man page, and look under “secure-execution
mode”.)</p>
<div class="solutions">
<p><strong>Sample solutions</strong></p>
<p>When the dynamic linker detects that a process’s real and effective
user IDs differ (as they do, for a setuid executable), it ignores the
value of environment variables which would normally alter the linker’s
behaviour (like <code>LD_LIBRARY_PATH</code>); furthermore, it strips
those variables out of the environment.</p>
<p>However, <code>LD_SOME_RANDOM_VAR</code> is not one of those
variables, so it remains in the environment.</p>
</div>
<!-- vim: syntax=markdown
-->
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>The <code>-fPIC</code> flag requests
the compiler to create “position independent code”, which can be moved
around in memory and still work.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>We can confirm this by running
several commands. <code>objdump -d --source mylib.o</code> will show us
the compiled assembly code for the <code>useful_func</code> function.
Running <code>objdump -d --source   static-libs/libmylib.a</code> will
confirm that it has been copied into
<code>static-libs/libmylib.a</code>. And
<code>objdump -d --source statically-linked-usemylib</code> will confirm
that it’s been copied into the executable
<code>statically-linked-usemylib</code> – look for the section headed
“<code>&lt;useful_func&gt;</code>”, and you’ll see the original assembly
code.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote">The process is roughly as follows (see
<a href="https://man7.org/linux/man-pages/man8/ld.so.8.html"><code>man 8 ld.so</code></a>
and “<a href="https://www.caichinger.com/elf.html">The ELF format - how
programs look from the inside</a>”). The kernel loads the executable
into memory, and looks to see if it contains an <code>INTERP</code>
directive, which specifies an interpreter to use. Statically linked
binaries don’t need an interpreter. Dynamically linked programs use
<code>/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</code>, which runs some
initialization code, loads shared libraries needed by the binary, and
performs <a href="https://en.wikipedia.org/wiki/Relocation_(computing)"><em>relocations</em></a>
– adjusts the code of an executable so that it looks at the right
addresses for any functions it needs.<br />
  See for more information “<a href="https://lwn.net/Articles/631631/">How programs get run: ELF
binaries</a>”.<br />
  An interesting side-effect of this setup is that you can use
<code>/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</code> to run a binary
even when it doesn’t have it’s “executable” permissions set. Remove the
executable permissions from some binary <code>mybinary</code> with
<code>chmod a-rx mybinary</code>, and you can still run it with the
command:<br />
<pre><code>/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 ./xxx</code></pre>
<p><!--
  See e.g.
  <https://stackoverflow.com/questions/69481807/who-performs-runtime-relocations>
  and
  <https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html>
  )
  --><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote">The linked
<code>dynamically-linked-usemylib</code> program contains what are
called “relocations” – descriptions of functions that will need to be
“filled in” when the executable is loaded into memory and shared
libraries are linked. Running
<code>readelf --relocs   ./dynamically-linked-usemylib</code> will tell
us what these are: we should be able to see an entry for
<code>printf</code> and <code>useful_func</code>:<br />
<pre><code>
  Relocation section &#39;.rela.plt&#39; at offset 0x610 contains 2 entries:
    Offset          Info           Type           Sym. Value    Sym. Name + Addend
  000000003fc8  000200000007 R_X86_64_JUMP_SLO 0000000000000000 printf@GLIBC_2.2.5 + 0
  000000003fd0  000500000007 R_X86_64_JUMP_SLO 0000000000000000 useful_func + 0
  </code></pre>
<p><br />
The relocation tells the dynamic linker: “After the executable is loaded
into memory, patch the address found at offset <code>000000003fd0</code>
(the first column), and replace it with the address of symbol
<code>useful_func</code>.”<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote">The <code>ldd</code> command can be used
to find out what shared libraries are required by an executable. Run
<code>ldd dynamically-linked-usemylib</code>, and you should get output
like the following:<br />
 <br />
<pre><code>$ ldd dynamically-linked-usemylib
linux-vdso.so.1 (0x00007ffe43a66000)
libmylib.so =&gt; not found
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f903fc18000)
/lib64/ld-linux-x86-64.so.2 (0x00007f903fe1b000)
  </code></pre>
<p><br />
This is telling us that one of the libraries this executable depends on,
<code>libmylib.so</code>, cannot be found using the current search
path.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>A third option is that we could make
use of the API provided by the dynamic linker to programmatically load
shared libraries and look up particular functions we want by name (using
the functions <a href="https://linux.die.net/man/3/dlopen"><code>dlopen</code></a> and <a href="https://man7.org/linux/man-pages/man3/dlsym.3.html"><code>dlsym</code></a>).
Effectively, we are doing manually what the dynamic linker does
automatically when an executable that uses shared libraries is
run.<br />
  This functionality is often used to make “plugins” for a program –
modules which can be downloaded and installed to augment the program’s
functionality. (For instance, a graphics editing program might use
plugins to allow it so save images in a new format.) See <a href="https://tldp.org/HOWTO/Program-Library-HOWTO/dl-libraries.html">“Dynamically
Loaded (DL) Libraries”</a> for more details.<br />
  Making use of plugins comes with risks, however: a plugin can perform
arbitrary actions at runtime, and it is very difficult to ensure in
advance that those actions are “safe”.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
